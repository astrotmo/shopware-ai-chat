(()=>{"use strict";let t=window.PluginBaseClass;window.PluginManager.register("PaulAiChatPlugin",class extends t{init(){let{chatUrl:t,buttonLabel:e,autoOpen:s,position:i}=this.el.dataset;this.chatUrl=this.normalizeUrl(t),this.buttonLabel=e||"Chat",this.autoOpen="1"===s,this.position=(i||"bottom-left").toLowerCase(),this.preferredPosition=this.position,this.buildUi(),this.restoreHistory(),this.enableSmartAvoidance(),this.autoOpen&&this.open()}normalizeUrl(t){if(!t)return null;try{return new URL(t,window.location.origin).toString()}catch{return/^https?:\/\//i.test(t)?t:`http://${t}`}}buildUi(){this.wrapper=document.createElement("div"),this.wrapper.className="paul-ai-chat-wrap",this.wrapper.classList.add("bottom-right"===this.position?"paul-ai-chat-bottom-right":"paul-ai-chat-bottom-left"),this.fab=document.createElement("button"),this.fab.type="button",this.fab.className="paul-ai-chat-button",this.fab.setAttribute("aria-haspopup","dialog"),this.fab.setAttribute("aria-expanded","false"),this.fab.textContent=this.buttonLabel,this.fab.addEventListener("click",()=>this.toggle()),this.panel=document.createElement("section"),this.panel.className="paul-ai-chat-window",this.panel.setAttribute("role","dialog"),this.panel.setAttribute("aria-label","Chat");let t=document.createElement("header");t.className="paul-ai-chat-header";let e=document.createElement("div");e.className="paul-ai-chat-title",e.textContent="Support Chat";let s=document.createElement("button");s.type="button",s.className="paul-ai-chat-clear",s.setAttribute("aria-label","Clear chat"),s.innerHTML="ðŸ—‘ï¸",s.title="Clear chat history",s.addEventListener("click",()=>this.clearHistory());let i=document.createElement("button");i.type="button",i.className="paul-ai-chat-close",i.setAttribute("aria-label","Close chat"),i.innerHTML="Ã—",i.title="Close chat",i.addEventListener("click",()=>this.close()),t.appendChild(e),t.appendChild(s),t.appendChild(i),this.messagesEl=document.createElement("div"),this.messagesEl.className="paul-ai-chat-messages",this.messagesEl.setAttribute("aria-live","polite"),this.form=document.createElement("form"),this.form.className="paul-ai-chat-form",this.input=document.createElement("input"),this.input.type="text",this.input.className="paul-ai-chat-input",this.input.placeholder="Type your messageâ€¦",this.input.autocomplete="off",this.sendBtn=document.createElement("button"),this.sendBtn.type="submit",this.sendBtn.className="paul-ai-chat-send",this.sendBtn.textContent="Send",this.form.appendChild(this.input),this.form.appendChild(this.sendBtn),this.form.addEventListener("submit",t=>this.onSubmit(t)),this.panel.appendChild(t),this.panel.appendChild(this.messagesEl),this.panel.appendChild(this.form),this.panel.style.display="none",this.wrapper.appendChild(this.fab),this.wrapper.appendChild(this.panel),document.body.appendChild(this.wrapper)}toggle(){"none"===this.panel.style.display?this.open():this.close()}open(){this.panel.style.display="flex",this.fab.setAttribute("aria-expanded","true"),this.input?.focus(),this.scrollMessagesToEnd(),this.saveOpenState(!0)}close(){this.panel.style.display="none",this.fab.setAttribute("aria-expanded","false"),this.saveOpenState(!1)}scrollMessagesToEnd(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight}appendBubble(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bot",s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=document.createElement("div");i.className=`paul-ai-chat-bubble ${"user"===e?"from-user":"from-bot"}`,s&&i.classList.add("is-error"),i.textContent=t,this.messagesEl.appendChild(i),this.scrollMessagesToEnd()}appendPending(){let t=document.createElement("div");return t.className="paul-ai-chat-pending from-bot",t.textContent="â€¦",this.messagesEl.appendChild(t),this.scrollMessagesToEnd(),t}async onSubmit(t){if(t.preventDefault(),!this.chatUrl||!this.input)return;let e=(this.input.value||"").trim();if(!e)return;this.appendBubble(e,"user"),this.persistMessage({who:"user",text:e}),this.input.value="",this.input.focus();let s=this.appendPending();try{let t;let i=await fetch(this.chatUrl,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})}),a=await i.text();if(!i.ok)throw Error(a||`HTTP ${i.status}`);try{t=JSON.parse(a)}catch{t={reply:a}}let n=(t.reply??t.message??a).toString();s.remove(),this.appendBubble(n,"bot"),this.persistMessage({who:"bot",text:n})}catch(e){s.remove();let t=e&&e.message?e.message:String(e);this.appendBubble(`Error: ${t}`,"bot",!0),this.persistMessage({who:"bot",text:`Error: ${t}`,isError:!0})}}storageKey(){return"paul-ai-chat-history"}openKey(){return"paul-ai-chat-open"}persistMessage(t){let e=this.storageKey(),s=this.readJson(e)||[];s.push({...t,ts:Date.now()}),sessionStorage.setItem(e,JSON.stringify(s))}saveOpenState(t){sessionStorage.setItem(this.openKey(),t?"1":"0")}restoreHistory(){for(let t of this.readJson(this.storageKey())||[])this.appendBubble(t.text,"user"===t.who?"user":"bot",!!t.isError);"1"===(sessionStorage.getItem(this.openKey())||"0")&&this.open()}clearHistory(){let t=this.storageKey();sessionStorage.removeItem(t),this.messagesEl.innerHTML="",this.appendBubble("Chat history cleared.","bot")}readJson(t){try{return JSON.parse(sessionStorage.getItem(t)||"null")}catch{return null}}currentPosition(){return this.position}setPosition(t){this.wrapper.classList.remove("paul-ai-chat-bottom-left","paul-ai-chat-bottom-right"),"bottom-right"===t?this.wrapper.classList.add("paul-ai-chat-bottom-right"):(t="bottom-left",this.wrapper.classList.add("paul-ai-chat-bottom-left")),this.position=t}getActiveBoxEl(){return this.panel&&"none"!==this.panel.style.display?this.panel:this.fab}rectsOverlap(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8;return!(t.right<e.left+s||t.left>e.right-s||t.bottom<e.top+s||t.top>e.bottom-s)}visibleRect(t){let e=getComputedStyle(t);if("none"===e.display||"hidden"===e.visibility||0===Number(e.opacity))return null;let s=t.getBoundingClientRect();return s.width<40||s.height<40?null:s}findObstructionRects(){let t=[],e=new Set;for(let s of[".offcanvas",".offcanvas.is-open",".offcanvas-overlay",".js-offcanvas-cart",".is--offcanvas",".minicart",".offcanvas-cart","[data-offcanvas-cart]",".header-cart-offcanvas"])document.querySelectorAll(s).forEach(s=>{if(e.has(s))return;let i=this.visibleRect(s);i&&(t.push({el:s,rect:i}),e.add(s))});return t.filter(t=>{let{rect:e}=t;return e.left<=32||32>=Math.abs(window.innerWidth-e.right)})}avoidObstruction(){let t=this.getActiveBoxEl();if(!t)return;let e=t.getBoundingClientRect(),s=this.findObstructionRects();if(0===s.length){this.preferredPosition&&this.currentPosition()!==this.preferredPosition&&this.setPosition(this.preferredPosition);return}if(!s.some(t=>{let{rect:s}=t;return this.rectsOverlap(e,s)}))return;let i="bottom-right"===this.currentPosition()?"bottom-left":"bottom-right";this.setPosition(i)}enableSmartAvoidance(){let t=()=>this.avoidObstruction();this._avoidanceRun=t,window.addEventListener("resize",t,{passive:!0}),window.addEventListener("scroll",t,{passive:!0}),this._observer=new MutationObserver(()=>{this._avoidTimer&&cancelAnimationFrame(this._avoidTimer),this._avoidTimer=requestAnimationFrame(t)}),this._observer.observe(document.body,{attributes:!0,childList:!0,subtree:!0});let e=()=>t();this.fab.addEventListener("click",e),this.panel&&this.panel.addEventListener("transitionend",e),t()}},"[paul-ai-chat-root]")})();