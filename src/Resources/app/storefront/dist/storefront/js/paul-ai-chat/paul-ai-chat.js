(()=>{"use strict";let t=window.PluginBaseClass;window.PluginManager.register("PaulAiChatPlugin",class extends t{init(){let{chatUrl:t,buttonLabel:e,autoOpen:s,position:a}=this.el.dataset;this.chatUrl=this.normalizeUrl(t),this.buttonLabel=e||"Chat",this.autoOpen="1"===s,this.position=(a||"bottom-left").toLowerCase(),this.buildUi(),this.restoreHistory(),this.autoOpen&&this.open()}normalizeUrl(t){if(!t)return null;try{return new URL(t,window.location.origin).toString()}catch{return/^https?:\/\//i.test(t)?t:`http://${t}`}}buildUi(){this.wrapper=document.createElement("div"),this.wrapper.className="paul-ai-chat-wrap",this.wrapper.classList.add("bottom-right"===this.position?"paul-ai-chat-bottom-right":"paul-ai-chat-bottom-left"),this.fab=document.createElement("button"),this.fab.type="button",this.fab.className="paul-ai-chat-button",this.fab.setAttribute("aria-haspopup","dialog"),this.fab.setAttribute("aria-expanded","false"),this.fab.textContent=this.buttonLabel,this.fab.addEventListener("click",()=>this.toggle()),this.panel=document.createElement("section"),this.panel.className="paul-ai-chat-window",this.panel.setAttribute("role","dialog"),this.panel.setAttribute("aria-label","Chat");let t=document.createElement("header");t.className="paul-ai-chat-header";let e=document.createElement("div");e.className="paul-ai-chat-title",e.textContent="Support Chat";let s=document.createElement("button");s.type="button",s.className="paul-ai-chat-close",s.setAttribute("aria-label","Close chat"),s.innerHTML="×",s.addEventListener("click",()=>this.close()),t.appendChild(e),t.appendChild(s),this.messagesEl=document.createElement("div"),this.messagesEl.className="paul-ai-chat-messages",this.messagesEl.setAttribute("aria-live","polite"),this.form=document.createElement("form"),this.form.className="paul-ai-chat-form",this.input=document.createElement("input"),this.input.type="text",this.input.className="paul-ai-chat-input",this.input.placeholder="Type your message…",this.input.autocomplete="off",this.sendBtn=document.createElement("button"),this.sendBtn.type="submit",this.sendBtn.className="paul-ai-chat-send",this.sendBtn.textContent="Send",this.form.appendChild(this.input),this.form.appendChild(this.sendBtn),this.form.addEventListener("submit",t=>this.onSubmit(t)),this.panel.appendChild(t),this.panel.appendChild(this.messagesEl),this.panel.appendChild(this.form),this.panel.style.display="none",this.wrapper.appendChild(this.fab),this.wrapper.appendChild(this.panel),document.body.appendChild(this.wrapper)}toggle(){"none"===this.panel.style.display?this.open():this.close()}open(){this.panel.style.display="flex",this.fab.setAttribute("aria-expanded","true"),this.input?.focus(),this.scrollMessagesToEnd(),this.saveOpenState(!0)}close(){this.panel.style.display="none",this.fab.setAttribute("aria-expanded","false"),this.saveOpenState(!1)}scrollMessagesToEnd(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight}appendBubble(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bot",s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=document.createElement("div");a.className=`paul-ai-chat-bubble ${"user"===e?"from-user":"from-bot"}`,s&&a.classList.add("is-error"),a.textContent=t,this.messagesEl.appendChild(a),this.scrollMessagesToEnd()}appendPending(){let t=document.createElement("div");return t.className="paul-ai-chat-pending from-bot",t.textContent="…",this.messagesEl.appendChild(t),this.scrollMessagesToEnd(),t}async onSubmit(t){if(t.preventDefault(),!this.chatUrl||!this.input)return;let e=(this.input.value||"").trim();if(!e)return;this.appendBubble(e,"user"),this.persistMessage({who:"user",text:e}),this.input.value="",this.input.focus();let s=this.appendPending();try{let t;let a=await fetch(this.chatUrl,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})}),i=await a.text();if(!a.ok)throw Error(i||`HTTP ${a.status}`);try{t=JSON.parse(i)}catch{t={reply:i}}let n=(t.reply??t.message??i).toString();s.remove(),this.appendBubble(n,"bot"),this.persistMessage({who:"bot",text:n})}catch(e){s.remove();let t=e&&e.message?e.message:String(e);this.appendBubble(`Error: ${t}`,"bot",!0),this.persistMessage({who:"bot",text:`Error: ${t}`,isError:!0})}}storageKey(){return"paul-ai-chat-history"}openKey(){return"paul-ai-chat-open"}persistMessage(t){let e=this.storageKey(),s=this.readJson(e)||[];s.push({...t,ts:Date.now()}),sessionStorage.setItem(e,JSON.stringify(s))}saveOpenState(t){sessionStorage.setItem(this.openKey(),t?"1":"0")}restoreHistory(){for(let t of this.readJson(this.storageKey())||[])this.appendBubble(t.text,"user"===t.who?"user":"bot",!!t.isError);"1"===(sessionStorage.getItem(this.openKey())||"0")&&this.open()}readJson(t){try{return JSON.parse(sessionStorage.getItem(t)||"null")}catch{return null}}},"[paul-ai-chat-root]")})();