(()=>{"use strict";let e=window.PluginBaseClass;window.PluginManager.register("PaulAiChatPlugin",class extends e{init(){let{chatUrl:e,buttonLabel:t,autoOpen:s,position:a}=this.el.dataset;if(this.chatUrl=this.normalizeUrl(e),!this.chatUrl){console.warn("[AiChatPlugin] Kein chatUrl gesetzt, Plugin wird nicht initialisiert.");return}this.buttonLabel=t||"Chat",this.autoOpen="1"===s,this.position=(a||"bottom-left").toLowerCase(),this.preferredPosition=this.position,this.wrapper=null,this.fab=null,this.panel=null,this.messagesEl=null,this.form=null,this.input=null,this.sendBtn=null,this.buildUi(),this.restoreHistory(),this.autoOpen&&setTimeout(()=>this.open(),400),window.addEventListener("resize",()=>this.scrollMessagesToEnd())}normalizeUrl(e){return e?e.startsWith("http://")||e.startsWith("https://")||e.startsWith("/")?e:`${window.location.origin.replace(/\/+$/,"")}/${e.replace(/^\/+/,"")}`:""}buildUi(){let e=document.createElement("div");e.className="paul-ai-chat-wrap",e.classList.add("bottom-right"===this.position?"paul-ai-chat-bottom-right":"paul-ai-chat-bottom-left"),this.wrapper=e;let t=document.createElement("button");t.type="button",t.className="paul-ai-chat-button",t.setAttribute("aria-haspopup","dialog"),t.setAttribute("aria-expanded","false"),t.textContent=this.buttonLabel,t.addEventListener("click",()=>this.toggle()),this.fab=t;let s=document.createElement("section");s.className="paul-ai-chat-window",s.setAttribute("aria-label","Chat mit Assistenz"),s.setAttribute("role","dialog"),s.style.display="none",this.panel=s;let a=document.createElement("header");a.className="paul-ai-chat-header";let i=document.createElement("div");i.className="paul-ai-chat-title",i.textContent=this.buttonLabel;let l=document.createElement("div");l.className="paul-ai-chat-header-controls";let n=document.createElement("button");n.type="button",n.className="paul-ai-chat-clear",n.title="Chatverlauf lÃ¶schen",n.innerHTML="ðŸ—‘ï¸",n.addEventListener("click",()=>this.clearHistory());let r=document.createElement("button");r.type="button",r.className="paul-ai-chat-close",r.title="Chat schlieÃŸen",r.innerHTML="Ã—",r.addEventListener("click",()=>this.close()),l.appendChild(n),l.appendChild(r),a.appendChild(i),a.appendChild(l);let o=document.createElement("div");o.className="paul-ai-chat-messages",this.messagesEl=o;let h=document.createElement("form");h.className="paul-ai-chat-form",this.form=h;let c=document.createElement("textarea");c.className="paul-ai-chat-input",c.rows=1,c.placeholder="Nachricht eingeben â€¦",c.style.resize="none",c.style.overflow="hidden",this.input=c,c.addEventListener("input",()=>{c.style.height="auto",c.style.height=c.scrollHeight+"px",c.style.transition="height 0.1s ease"});let p=document.createElement("button");p.type="submit",p.className="paul-ai-chat-send",p.textContent="Senden",this.sendBtn=p,h.appendChild(c),h.appendChild(p),h.addEventListener("submit",e=>this.onSubmit(e)),s.appendChild(a),s.appendChild(o),s.appendChild(h),e.appendChild(t),e.appendChild(s),document.body.appendChild(e)}open(){this.panel&&(this.panel.style.display="flex",this.wrapper.classList.add("paul-ai-chat-open"),this.fab.setAttribute("aria-expanded","true"),this.saveOpenState(!0),this.scrollMessagesToEnd(),this.input&&this.input.focus())}close(){this.panel&&(this.panel.style.display="none",this.wrapper.classList.remove("paul-ai-chat-open"),this.fab.setAttribute("aria-expanded","false"),this.saveOpenState(!1))}toggle(){this.panel&&("none"!==this.panel.style.display?this.close():this.open())}appendBubble(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bot",s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.messagesEl)return null;let a=document.createElement("div");a.className="paul-ai-chat-bubble "+("user"===t?"from-user":"from-bot"),s&&a.classList.add("is-error");let i=document.createElement("div");return i.className="paul-ai-chat-bubble-inner",i.innerHTML=this.linkify(e||""),a.appendChild(i),this.messagesEl.appendChild(a),this.scrollMessagesToEnd(),a}appendPending(){let e=document.createElement("div");return e.className="paul-ai-chat-pending",e.textContent="â€¦",this.messagesEl.appendChild(e),this.scrollMessagesToEnd(),e}linkify(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/(https?:\/\/[^\s]+)/g,e=>{let t=e.replace(/"/g,"&quot;");return`<a href="${t}" target="_self" class="paul-ai-chat-link">${t}</a>`}):""}scrollMessagesToEnd(){this.messagesEl&&(this.messagesEl.scrollTop=this.messagesEl.scrollHeight)}async onSubmit(e){if(e.preventDefault(),!this.chatUrl||!this.input)return;let t=(this.input.value||"").trim();if(!t)return;this.appendBubble(t,"user"),this.persistMessage({who:"user",text:t}),this.input.value="",this.input.focus();let s=this.appendPending();try{let e;let a=await fetch(this.chatUrl,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})}),i=await a.text();if(!a.ok)throw Error(i||`HTTP ${a.status}`);try{e=JSON.parse(i)}catch{e=null}s.remove(),this.handleBotResponse(e,i)}catch(t){s.remove();let e=t&&t.message?t.message:String(t);this.appendBubble(`Error: ${e}`,"bot",!0),this.persistMessage({who:"bot",text:`Error: ${e}`,isError:!0})}}handleBotResponse(e,t){if(e&&Array.isArray(e.blocks)){this.renderBlocks(e.blocks),this.persistMessage({who:"bot",structured:!0,payload:e});return}let s=e&&(e.reply??e.message)||t;this.appendBubble(s.toString(),"bot"),this.persistMessage({who:"bot",text:s.toString()})}renderBlocks(e){if(Array.isArray(e)){for(let t of e)this.renderBlock(t);this.scrollMessagesToEnd()}}renderBlock(e){if(e&&"object"==typeof e)switch(e.kind){case"text":default:e.text&&this.appendBubble(e.text,"bot");break;case"product_list":this.renderProductList(e);break;case"info_box":this.renderInfoBox(e)}}renderProductList(e){if(!this.messagesEl)return;let t=document.createElement("div");if(t.className="paul-ai-chat-product-list",e.title){let s=document.createElement("div");s.className="paul-ai-chat-product-list-title",s.textContent=e.title,t.appendChild(s)}let s=document.createElement("div");for(let t of(s.className="paul-ai-chat-product-list-items",Array.isArray(e.products)?e.products:[])){if(!t||!t.name||!t.detailUrl)continue;let e=document.createElement("a");e.className="paul-ai-chat-product-card",e.href=t.detailUrl,e.target="_self";let a=document.createElement("div");if(a.className="paul-ai-chat-product-name",a.textContent=t.name,e.appendChild(a),t.price){let s=document.createElement("div");s.className="paul-ai-chat-product-price",s.textContent=t.price,e.appendChild(s)}s.appendChild(e)}t.appendChild(s),this.messagesEl.appendChild(t),this.scrollMessagesToEnd()}renderInfoBox(e){if(!this.messagesEl)return;let t=document.createElement("div");if(t.className="paul-ai-chat-info-box",e.style&&t.classList.add(`paul-ai-chat-info-${e.style}`),e.title){let s=document.createElement("div");s.className="paul-ai-chat-info-title",s.textContent=e.title,t.appendChild(s)}if(e.text){let s=document.createElement("div");s.className="paul-ai-chat-info-text",s.textContent=e.text,t.appendChild(s)}this.messagesEl.appendChild(t),this.scrollMessagesToEnd()}storageKey(){return"paul-ai-chat-history"}openKey(){return"paul-ai-chat-open"}persistMessage(e){let t=this.storageKey(),s=this.readJson(t)||[];s.push({...e,ts:Date.now()}),sessionStorage.setItem(t,JSON.stringify(s))}saveOpenState(e){sessionStorage.setItem(this.openKey(),e?"1":"0")}restoreHistory(){for(let e of this.readJson(this.storageKey())||[])e.structured&&e.payload&&Array.isArray(e.payload.blocks)?this.renderBlocks(e.payload.blocks):e.text&&this.appendBubble(e.text,"user"===e.who?"user":"bot",!!e.isError);"1"===(sessionStorage.getItem(this.openKey())||"0")&&this.open()}readJson(e){try{let t=sessionStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return console.warn("[AiChatPlugin] Konnte JSON aus sessionStorage nicht lesen:",e),null}}clearHistory(){sessionStorage.removeItem(this.storageKey()),this.messagesEl&&(this.messagesEl.innerHTML="")}},"[paul-ai-chat-root]")})();